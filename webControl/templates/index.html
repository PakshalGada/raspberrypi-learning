<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI CONTROL HUB</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>PI CONTROL HUB</h1>
        <h2>Camera Stream</h2>
        <div class="video-container">
            <img src="{{ url_for('video_feed') }}" alt="Video Stream" class="video-feed">
        </div>
        <div class="controls">
            <button onclick="fetch('/zoom_in').then(response => response.text()).then(data => console.log(data))">Zoom In</button>
            <button onclick="fetch('/zoom_out').then(response => response.text()).then(data => console.log(data))">Zoom Out</button>
            <button onclick="fetch('/arm').then(response => response.text()).then(data => console.log(data))">Arm</button>
            <button onclick="fetch('/disarm').then(response => response.text()).then(data => console.log(data))">Disarm</button>
            <button onclick="takePicture()">Take Picture</button>
        </div>
        <div class="distance">
            <h2>Distance</h2>
            <p id="distance">Not measuring</p>
        </div>
        <h2>Snapshots</h2>
        <div class="gallery" id="gallery">
            {% for image in images %}
                <img src="{{ url_for('static', filename='photo/' + image) }}" alt="Snapshot" class="gallery-img" onclick="openModal('{{ url_for('static', filename='photo/' + image) }}')">
            {% endfor %}
        </div>
    </div>
    <!-- Modal for full-size image -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
    <script>
        function openModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = src;
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function updateGallery() {
            fetch('/get_images')
                .then(response => response.json())
                .then(images => {
                    const gallery = document.getElementById('gallery');
                    const currentImages = Array.from(gallery.getElementsByTagName('img')).map(img => img.src.split('/').pop());
                    const newImages = images.filter(img => !currentImages.includes(img));
                    
                    newImages.forEach(image => {
                        const imgElement = document.createElement('img');
                        imgElement.src = `/static/photo/${image}`;
                        imgElement.alt = 'Snapshot';
                        imgElement.className = 'gallery-img';
                        imgElement.onclick = () => openModal(imgElement.src);
                        gallery.insertBefore(imgElement, gallery.firstChild); // Add new images at the start
                    });
                })
                .catch(error => console.error('Error updating gallery:', error));
        }

        function updateDistance() {
            fetch('/get_distance')
                .then(response => response.json())
                .then(data => {
                    const distanceElement = document.getElementById('distance');
                    if (data.distance === null) {
                        distanceElement.textContent = 'Not measuring';
                    } else {
                        distanceElement.textContent = `${data.distance} cm`;
                    }
                })
                .catch(error => console.error('Error updating distance:', error));
        }

        function takePicture() {
            fetch('/take_picture')
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    if (data.includes('successfully')) {
                        setTimeout(updateGallery, 500); // Delay to ensure file is saved
                    }
                })
                .catch(error => console.error('Error taking picture:', error));
        }

        // Poll for new images and distance every 1 second
        setInterval(() => {
            updateGallery();
            updateDistance();
        }, 1000);
        
        // Initial updates
        updateGallery();
        updateDistance();
    </script>
</body>
</html>
